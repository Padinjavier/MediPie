<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Problemas</title>
    <script src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        #mynetwork {
            width: 95%;
            height: 600px;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #6a7fdb;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-title {
            color: #6a7fdb;
            margin-top: 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #6a7fdb;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #5a6fcb;
        }
        .button-cancel {
            background-color: #f44336;
        }
        .button-cancel:hover {
            background-color: #d32f2f;
        }
        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            min-width: 180px;
        }
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        .context-menu-header {
            padding: 8px 15px;
            font-weight: bold;
            color: #6a7fdb;
            background-color: #f8f9ff;
            border-radius: 6px 6px 0 0;
        }
    </style>
</head>
<body>

<h2>Mapa de Problemas y Subproblemas</h2>
<p>Haz clic derecho para opciones. Haz clic en un área vacía para crear nuevo problema.</p>
<div id="mynetwork"></div>

<!-- Modal para crear problema -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modalTitle">Crear Problema</h3>
        <input type="text" id="problemName" placeholder="Nombre del problema">
        <div>
            <button id="confirmCreate">Crear</button>
            <button id="cancelCreate" class="button-cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- Menú contextual -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-header">Opciones</div>
    <div id="addProblem" class="context-menu-item">➕ Agregar Problema</div>
    <div id="addSubproblem" class="context-menu-item">🔹 Agregar Subproblema</div>
    <div id="deleteConnection" class="context-menu-item">✖ Eliminar Conexión</div>
    <div id="deleteNode" class="context-menu-item">🗑 Eliminar Nodo</div>
</div>

<script>
    // Colores pastel
    const colors = {
        problema: '#FFB6C1', // Rosa pastel
        subproblema: '#B5EAD7', // Verde menta pastel
        selected: '#C7CEEA', // Azul lila pastel
        edge: '#E2F0CB' // Verde claro pastel
    };

    // Crear nodos iniciales
    var nodes = new vis.DataSet([
        { id: 1, label: "💻 Problema 1", shape: "box", color: colors.problema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 2, label: "🌐 Problema 2", shape: "box", color: colors.problema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 3, label: "📂 Problema 3", shape: "box", color: colors.problema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 4, label: "📊 Problema 4", shape: "box", color: colors.problema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 5, label: "🔌 No enciende", shape: "box", color: colors.subproblema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 6, label: "❄ Se congela", shape: "box", color: colors.subproblema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 7, label: "📶 Internet lento", shape: "box", color: colors.subproblema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 },
        { id: 8, label: "🚫 Sin conexión", shape: "box", color: colors.subproblema, borderWidth: 2, borderWidthSelected: 3, 
          font: { size: 14 }, margin: 10, shadow: { enabled: true }, borderRadius: 10 }
    ]);

    // Crear conexiones iniciales
    var edges = new vis.DataSet([
        { from: 1, to: 5, color: { color: colors.edge }, width: 2, smooth: { type: 'curvedCW', roundness: 0.2 } },
        { from: 1, to: 6, color: { color: colors.edge }, width: 2, smooth: { type: 'curvedCW', roundness: 0.2 } },
        { from: 2, to: 7, color: { color: colors.edge }, width: 2, smooth: { type: 'curvedCW', roundness: 0.2 } },
        { from: 2, to: 8, color: { color: colors.edge }, width: 2, smooth: { type: 'curvedCW', roundness: 0.2 } }
    ]);

    var container = document.getElementById("mynetwork");
    var data = { nodes: nodes, edges: edges };
    var options = {
        interaction: { 
            dragNodes: true,
            multiselect: false,
            hover: true
        },
        physics: { 
            enabled: true,
            solver: 'repulsion',
            repulsion: {
                nodeDistance: 150, // Menor distancia entre nodos
                centralGravity: 0.3,
                springLength: 100,
                springConstant: 0.05,
                damping: 0.09
            },
            hierarchicalRepulsion: {
                nodeDistance: 150 // Menor distancia para nodos jerárquicos
            }
        },
        nodes: {
            shape: 'box',
            borderWidth: 2,
            borderWidthSelected: 3,
            shadow: {
                enabled: true,
                color: 'rgba(0,0,0,0.1)',
                size: 10,
                x: 5,
                y: 5
            },
            font: {
                size: 14,
                face: 'Arial'
            },
            margin: 10,
            borderRadius: 10
        },
        edges: {
            color: colors.edge,
            width: 2,
            smooth: {
                type: 'curvedCW',
                roundness: 0.2
            },
            selectionWidth: 3
        },
        layout: {
            improvedLayout: true,
            randomSeed: 42 // Para consistencia en la disposición
        }
    };
    var network = new vis.Network(container, data, options);

    var selectedSubproblema = null;
    var nextId = 9; // Para nuevos nodos
    var createModal = document.getElementById("createModal");
    var contextMenu = document.getElementById("contextMenu");
    var selectedEdge = null;
    var selectedNode = null;
    var isCreatingSubproblem = false;
    var lastClickPosition = { x: 0, y: 0 };

    // Mostrar modal al hacer clic en área vacía
    network.on("oncontext", function(params) {
        params.event.preventDefault();
        lastClickPosition = { x: params.pointer.DOM.x, y: params.pointer.DOM.y };
        
        if (params.nodes.length > 0) {
            // Click en nodo - mostrar menú contextual completo
            selectedNode = params.nodes[0];
            contextMenu.style.display = 'block';
            contextMenu.style.left = params.pointer.DOM.x + 'px';
            contextMenu.style.top = params.pointer.DOM.y + 'px';
            
            // Mostrar/ocultar opciones según contexto
            var connectedEdges = network.getConnectedEdges(selectedNode);
            document.getElementById("deleteConnection").style.display = connectedEdges.length > 0 ? 'block' : 'none';
            document.getElementById("addSubproblem").style.display = 'block';
            document.getElementById("addProblem").style.display = 'block';
        } else if (params.edges.length > 0) {
            // Click en arista - mostrar menú para eliminar conexión
            selectedEdge = params.edges[0];
            contextMenu.style.display = 'block';
            contextMenu.style.left = params.pointer.DOM.x + 'px';
            contextMenu.style.top = params.pointer.DOM.y + 'px';
            document.getElementById("deleteNode").style.display = 'none';
            document.getElementById("deleteConnection").style.display = 'block';
            document.getElementById("addSubproblem").style.display = 'block';
            document.getElementById("addProblem").style.display = 'block';
        } else {
            // Click en área vacía - mostrar opciones de creación
            contextMenu.style.display = 'block';
            contextMenu.style.left = params.pointer.DOM.x + 'px';
            contextMenu.style.top = params.pointer.DOM.y + 'px';
            document.getElementById("deleteNode").style.display = 'none';
            document.getElementById("deleteConnection").style.display = 'none';
            document.getElementById("addSubproblem").style.display = 'block';
            document.getElementById("addProblem").style.display = 'block';
        }
    });

    // Cerrar menú contextual al hacer clic fuera
    document.addEventListener('click', function() {
        contextMenu.style.display = 'none';
    });

    // Evento al hacer clic en un nodo
    network.on("click", function(params) {
        if (params.nodes.length > 0) {
            let nodeId = params.nodes[0];
            let node = nodes.get(nodeId);

            // Si es un subproblema, lo seleccionamos
            if (node.color === colors.subproblema || isCreatingSubproblem) {
                selectedSubproblema = nodeId;
                nodes.update({id: nodeId, color: colors.selected});
            } 
            // Si es un problema, lo conectamos al subproblema seleccionado
            else if (selectedSubproblema !== null) {
                edges.remove(edges.get({
                    filter: (edge) => edge.to === selectedSubproblema
                }));

                edges.add({ 
                    from: nodeId, 
                    to: selectedSubproblema,
                    color: { color: colors.edge },
                    width: 2,
                    smooth: { type: 'curvedCW', roundness: 0.2 }
                });
                
                // Restaurar color del subproblema
                nodes.update({id: selectedSubproblema, color: colors.subproblema});
                selectedSubproblema = null;
                isCreatingSubproblem = false;
            }
        }
    });

    // Agregar problema desde menú contextual
    document.getElementById("addProblem").addEventListener('click', function() {
        isCreatingSubproblem = false;
        document.getElementById("modalTitle").textContent = "Crear Problema";
        document.getElementById("problemName").placeholder = "Nombre del problema";
        createModal.style.display = 'block';
        contextMenu.style.display = 'none';
    });

    // Agregar subproblema desde menú contextual
    document.getElementById("addSubproblem").addEventListener('click', function() {
        if (selectedNode) {
            isCreatingSubproblem = true;
            selectedSubproblema = selectedNode;
            document.getElementById("modalTitle").textContent = "Crear Subproblema";
            document.getElementById("problemName").placeholder = "Nombre del subproblema";
            createModal.style.display = 'block';
            contextMenu.style.display = 'block';
        }
    });

    // Confirmar creación de problema
    document.getElementById("confirmCreate").addEventListener('click', function() {
        var name = document.getElementById("problemName").value.trim();
        if (name) {
            var isSubproblem = isCreatingSubproblem;
            
            var newNode = {
                id: nextId,
                label: (isSubproblem ? "🔹 " : "📌 ") + name,
                shape: "box",
                color: isSubproblem ? colors.subproblema : colors.problema,
                borderWidth: 2,
                borderWidthSelected: 3,
                font: { size: 14 },
                margin: 10,
                shadow: { enabled: true },
                borderRadius: 10
            };

            nodes.add(newNode);

            // Posicionar el nuevo nodo cerca del cursor
            if (isSubproblem && selectedSubproblema) {
                edges.add({ 
                    from: selectedSubproblema, 
                    to: nextId,
                    color: { color: colors.edge },
                    width: 2,
                    smooth: { type: 'curvedCW', roundness: 0.2 }
                });
            } else {
                // Para problemas nuevos, posicionar cerca del clic
                var pos = network.canvasToDOM({ x: lastClickPosition.x, y: lastClickPosition.y });
                nodes.update([{ id: nextId, x: pos.x, y: pos.y }]);
            }

            nextId++;
            createModal.style.display = 'none';
            document.getElementById("problemName").value = '';
        }
    });

    // Cancelar creación
    document.getElementById("cancelCreate").addEventListener('click', function() {
        createModal.style.display = 'none';
        document.getElementById("problemName").value = '';
        selectedSubproblema = null;
        isCreatingSubproblem = false;
    });

    // Eliminar conexión
    document.getElementById("deleteConnection").addEventListener('click', function() {
        if (selectedEdge) {
            edges.remove(selectedEdge);
        } else if (selectedNode) {
            var connectedEdges = network.getConnectedEdges(selectedNode);
            edges.remove(connectedEdges);
        }
        contextMenu.style.display = 'none';
    });

    // Eliminar nodo
    document.getElementById("deleteNode").addEventListener('click', function() {
        if (selectedNode) {
            nodes.remove(selectedNode);
        }
        contextMenu.style.display = 'none';
    });
</script>

</body>
</html>